<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}JetFlix{% endblock %}</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'home/style.css' %}">
  {% block extra_css %}{% endblock %}
  <style>
    /* Search Icon Enhancements */
    .nav-icon {
      position: relative;
    }

    /* Search Sidebar */
    .search-sidebar {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background-color: #141414;
      z-index: 9999;
      transition: right 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }

    .search-sidebar.open {
      right: 0;
    }

    .search-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-sidebar-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }

    .search-close-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .search-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .search-sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Search Input */
    .sidebar-search-input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }

    .sidebar-search-input {
      width: 100%;
      padding: 14px 45px 14px 16px;
      font-size: 15px;
      background-color: #222;
      border: 2px solid #333;
      border-radius: 8px;
      color: #fff;
      transition: all 0.3s;
    }

    .sidebar-search-input:focus {
      outline: none;
      border-color: #e50914;
      background-color: #2a2a2a;
    }

    .sidebar-search-icon {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      pointer-events: none;
    }

    /* Filter Button */
    .sidebar-filter-btn {
      width: 100%;
      padding: 12px;
      background-color: #2a2a2a;
      border: 2px solid #3a3a3a;
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .sidebar-filter-btn:hover {
      background-color: #333;
      border-color: #444;
    }

    .sidebar-filter-btn.active {
      background-color: #e50914;
      border-color: #e50914;
    }

    /* Filter Panel */
    .sidebar-filter-panel {
      background-color: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .sidebar-filter-panel.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sidebar-filter-section {
      margin-bottom: 16px;
    }

    .sidebar-filter-section:last-child {
      margin-bottom: 0;
    }

    .sidebar-filter-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: #e5e5e5;
    }

    .sidebar-filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sidebar-filter-option {
      padding: 6px 12px;
      background-color: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 16px;
      color: #ccc;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-filter-option:hover {
      background-color: #333;
      color: #fff;
    }

    .sidebar-filter-option.selected {
      background-color: #e50914;
      border-color: #e50914;
      color: #fff;
    }

    .sidebar-filter-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2a2a2a;
    }

    .sidebar-filter-apply, .sidebar-filter-clear {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-filter-apply {
      background-color: #e50914;
      border: none;
      color: #fff;
    }

    .sidebar-filter-apply:hover {
      background-color: #f6121d;
    }

    .sidebar-filter-clear {
      background-color: transparent;
      border: 1px solid #555;
      color: #ccc;
    }

    .sidebar-filter-clear:hover {
      border-color: #777;
      color: #fff;
    }

    /* Results Count */
    .sidebar-results-count {
      font-size: 14px;
      color: #888;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #2a2a2a;
    }

    /* Search Results */
    .sidebar-search-results {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-movie-item {
      display: flex;
      gap: 12px;
      padding: 10px;
      background-color: #1a1a1a;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .sidebar-movie-item:hover {
      background-color: #222;
      border-color: #e50914;
      transform: translateX(4px);
    }

    .sidebar-movie-thumb {
      width: 60px;
      height: 90px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .sidebar-movie-info {
      flex: 1;
      min-width: 0;
    }

    .sidebar-movie-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sidebar-movie-meta {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .sidebar-movie-rating {
      color: #46d369;
      font-weight: 600;
    }

    .sidebar-movie-genre {
      display: inline-block;
      background-color: rgba(229, 9, 20, 0.3);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      color: #e50914;
      margin-top: 4px;
    }

    .sidebar-empty {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    /* Overlay */
    .search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .search-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .search-sidebar {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <!-- Search Overlay -->
  <div class="search-overlay" id="searchOverlay" onclick="closeSearchSidebar()"></div>

  <!-- Search Sidebar -->
  <div class="search-sidebar" id="searchSidebar">
    <div class="search-sidebar-header">
      <h2 class="search-sidebar-title">Search Movies</h2>
      <button class="search-close-btn" onclick="closeSearchSidebar()">&times;</button>
    </div>
    
    <div class="search-sidebar-body">
      <!-- Search Input -->
      <div class="sidebar-search-input-wrapper">
        <input 
          type="text" 
          class="sidebar-search-input" 
          id="sidebarSearchInput"
          placeholder="Search movies..."
          autocomplete="off"
        >
        <svg class="sidebar-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </div>

      <!-- Filter Button -->
      <button class="sidebar-filter-btn" id="sidebarFilterBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
        Filters
      </button>

      <!-- Filter Panel -->
      <div class="sidebar-filter-panel" id="sidebarFilterPanel">
        <div class="sidebar-filter-section">
          <label class="sidebar-filter-label">Language</label>
          <div class="sidebar-filter-options" id="sidebarLanguageFilters"></div>
        </div>
        
        <div class="sidebar-filter-section">
          <label class="sidebar-filter-label">Genre</label>
          <div class="sidebar-filter-options" id="sidebarGenreFilters"></div>
        </div>
        
        <div class="sidebar-filter-actions">
          <button class="sidebar-filter-apply" onclick="applySidebarFilters()">Apply</button>
          <button class="sidebar-filter-clear" onclick="clearSidebarFilters()">Clear</button>
        </div>
      </div>

      <!-- Results Count -->
      <div class="sidebar-results-count" id="sidebarResultsCount">
        Start typing to search...
      </div>

      <!-- Search Results -->
      <div class="sidebar-search-results" id="sidebarSearchResults">
        <div class="sidebar-empty">Start typing to search movies...</div>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-container">
      <!-- Logo -->
      <div class="navbar-left">
        <a href="{% url 'home' %}" class="logo">JETFLIX</a>
        
        {% if user.is_authenticated %}
        <!-- Navigation Links for logged in users -->
        <div class="nav-links">
          <a href="{% url 'home' %}" class="nav-link">Home</a>
          <a href="{% url 'movies:landing' %}" class="nav-link">Movies</a>
        </div>
        {% endif %}
      </div>

      <!-- Right Side Navigation -->
      <div class="navbar-right">
        {% if user.is_authenticated %}
          <!-- Search Icon -->
          <a href="javascript:void(0)" class="nav-icon" title="Search" onclick="openSearchSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </a>
          
          <!-- Watchlist -->
          <a href="{% url 'movies:watchlist' %}" class="nav-icon" title="Watchlist">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
          </a>

          <!-- Profile Dropdown -->
          <div class="profile-dropdown">
            <button class="profile-btn">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown-menu">
              <a href="{% url 'profile' %}" class="dropdown-item">Profile</a>
              <a href="{% url 'watch_history' %}" class="dropdown-item">Watch History</a>
              <div class="dropdown-divider"></div>
              <a href="{% url 'logout' %}" class="dropdown-item">Logout</a>
            </div>
          </div>
        {% else %}
          <!-- Links for logged out users -->
          <div class="nav-links">
            <a href="{% url 'login' %}" class="nav-link-btn">Login</a>
          </div>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    {% block content %}
    {% endblock %}
  </main>

  

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-links">
        <div class="footer-column">
          <a href="#">FAQ</a>
          <a href="#">Investor Relations</a>
          <a href="#">Privacy</a>
          <a href="#">Speed Test</a>
        </div>
        <div class="footer-column">
          <a href="#">Help Center</a>
          <a href="#">Jobs</a>
          <a href="#">Cookie Preferences</a>
          <a href="#">Legal Notices</a>
        </div>
        <div class="footer-column">
          <a href="#">Account</a>
          <a href="#">Ways to Watch</a>
          <a href="#">Corporate Information</a>
          <a href="#">Only on JetFlix</a>
        </div>
        <div class="footer-column">
          <a href="#">Media Center</a>
          <a href="#">Terms of Use</a>
          <a href="#">Contact Us</a>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 JetFlix, Inc.</p>
        <p>&copy; Designed and Developed by Kushal & Rabin</p>
      </div>
    </div>
  </footer>

  <script>
    // Navbar scroll effect and search initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Navbar scroll effect
      const navbar = document.querySelector('.navbar');
      let lastScroll = 0;

      window.addEventListener('scroll', function() {
        const currentScroll = window.pageYOffset;
        
        if (currentScroll > 50) {
          navbar.classList.add('navbar-scrolled');
        } else {
          navbar.classList.remove('navbar-scrolled');
        }
        
        lastScroll = currentScroll;
      });

      // Initialize search sidebar if on homepage
      if (typeof initSearchSidebar === 'function') {
        initSearchSidebar();
      }
    });

    // Search Sidebar Variables
    let sidebarMovies = [];
    let sidebarFilteredMovies = [];
    let sidebarSelectedLanguages = [];
    let sidebarSelectedGenres = [];
    let searchTimeout;

    function initSearchSidebar() {
      // Fetch all movies data (you'll need to provide this from Django)
      sidebarMovies = window.allMoviesData || [];
      sidebarFilteredMovies = [...sidebarMovies];
      
      // Initialize filters
      initializeSidebarFilters();
      
      // Don't display movies initially - wait for user input
      displayInitialState();
      
      // Setup search input listener
      const searchInput = document.getElementById('sidebarSearchInput');
      searchInput.addEventListener('input', handleSidebarSearch);
      
      // Setup filter button
      const filterBtn = document.getElementById('sidebarFilterBtn');
      filterBtn.addEventListener('click', toggleSidebarFilters);
    }

    function initializeSidebarFilters() {
      if (sidebarMovies.length === 0) return;

      // Extract unique languages
      const languages = [...new Set(sidebarMovies.map(m => m.language))].filter(l => l && l !== 'Unknown');
      const languageContainer = document.getElementById('sidebarLanguageFilters');
      languageContainer.innerHTML = languages.map(lang => 
        `<div class="sidebar-filter-option" onclick="toggleSidebarFilter('language', '${lang}', this)">${lang}</div>`
      ).join('');

      // Extract unique genres
      const genresSet = new Set();
      sidebarMovies.forEach(m => {
        if (m.genres) {
          m.genres.split(',').forEach(g => genresSet.add(g.trim()));
        }
      });
      const genres = [...genresSet].filter(g => g);
      const genreContainer = document.getElementById('sidebarGenreFilters');
      genreContainer.innerHTML = genres.map(genre => 
        `<div class="sidebar-filter-option" onclick="toggleSidebarFilter('genre', '${genre}', this)">${genre}</div>`
      ).join('');
    }

    function toggleSidebarFilter(type, value, element) {
      element.classList.toggle('selected');
      
      if (type === 'language') {
        const index = sidebarSelectedLanguages.indexOf(value);
        if (index > -1) {
          sidebarSelectedLanguages.splice(index, 1);
        } else {
          sidebarSelectedLanguages.push(value);
        }
      } else if (type === 'genre') {
        const index = sidebarSelectedGenres.indexOf(value);
        if (index > -1) {
          sidebarSelectedGenres.splice(index, 1);
        } else {
          sidebarSelectedGenres.push(value);
        }
      }
    }

    function applySidebarFilters() {
      let filtered = [...sidebarMovies];

      // Apply search query if exists
      const searchQuery = document.getElementById('sidebarSearchInput').value.trim().toLowerCase();
      if (searchQuery) {
        filtered = filtered.filter(m => 
          m.title.toLowerCase().includes(searchQuery) ||
          (m.description && m.description.toLowerCase().includes(searchQuery)) ||
          (m.cast && m.cast.toLowerCase().includes(searchQuery))
        );
      }

      // Apply language filter
      if (sidebarSelectedLanguages.length > 0) {
        filtered = filtered.filter(m => sidebarSelectedLanguages.includes(m.language));
      }

      // Apply genre filter
      if (sidebarSelectedGenres.length > 0) {
        filtered = filtered.filter(m => {
          const movieGenres = m.genres.split(',').map(g => g.trim());
          return sidebarSelectedGenres.some(sg => movieGenres.includes(sg));
        });
      }

      sidebarFilteredMovies = filtered;
      displaySidebarResults(filtered);
      
      // Update filter button state
      const filterBtn = document.getElementById('sidebarFilterBtn');
      if (sidebarSelectedLanguages.length > 0 || sidebarSelectedGenres.length > 0) {
        filterBtn.classList.add('active');
      } else {
        filterBtn.classList.remove('active');
      }
      
      // Hide filter panel
      document.getElementById('sidebarFilterPanel').classList.remove('show');
    }

    function clearSidebarFilters() {
      sidebarSelectedLanguages = [];
      sidebarSelectedGenres = [];
      
      document.querySelectorAll('.sidebar-filter-option').forEach(el => {
        el.classList.remove('selected');
      });
      
      document.getElementById('sidebarFilterBtn').classList.remove('active');
      document.getElementById('sidebarFilterPanel').classList.remove('show');
      
      // Reapply search without filters
      handleSidebarSearch({ target: document.getElementById('sidebarSearchInput') });
    }

    function toggleSidebarFilters() {
      const panel = document.getElementById('sidebarFilterPanel');
      panel.classList.toggle('show');
    }

    function handleSidebarSearch(e) {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim().toLowerCase();
      
      // If no query, show initial state
      if (query.length === 0) {
        displayInitialState();
        return;
      }
      
      searchTimeout = setTimeout(() => {
        let results = [...sidebarMovies];
        
        results = results.filter(m => 
          m.title.toLowerCase().includes(query) ||
          (m.description && m.description.toLowerCase().includes(query)) ||
          (m.cast && m.cast.toLowerCase().includes(query))
        );
        
        // Apply filters if any
        if (sidebarSelectedLanguages.length > 0) {
          results = results.filter(m => sidebarSelectedLanguages.includes(m.language));
        }
        
        if (sidebarSelectedGenres.length > 0) {
          results = results.filter(m => {
            const movieGenres = m.genres.split(',').map(g => g.trim());
            return sidebarSelectedGenres.some(sg => movieGenres.includes(sg));
          });
        }
        
        sidebarFilteredMovies = results;
        displaySidebarResults(results);
      }, 300);
    }

    function displaySidebarResults(movies) {
      const container = document.getElementById('sidebarSearchResults');
      const countEl = document.getElementById('sidebarResultsCount');
      
      countEl.textContent = `${movies.length} ${movies.length === 1 ? 'movie' : 'movies'} found`;
      
      if (movies.length === 0) {
        container.innerHTML = '<div class="sidebar-empty">No movies found</div>';
        return;
      }
      
      container.innerHTML = movies.map(movie => `
        <div class="sidebar-movie-item" onclick="openMovieModalFromSidebar(${movie.id})">
          <img src="${movie.thumbnail}" alt="${movie.title}" class="sidebar-movie-thumb">
          <div class="sidebar-movie-info">
            <div class="sidebar-movie-title">${movie.title}</div>
            <div class="sidebar-movie-meta">
              <span class="sidebar-movie-rating">★ ${movie.rating.toFixed(1)}</span>
              <span> • ${movie.year}</span>
              <span> • ${movie.language}</span>
            </div>
            <span class="sidebar-movie-genre">${movie.genres}</span>
          </div>
        </div>
      `).join('');
    }

    function displayInitialState() {
      const container = document.getElementById('sidebarSearchResults');
      const countEl = document.getElementById('sidebarResultsCount');
      
      countEl.textContent = `${sidebarMovies.length} movies available`;
      container.innerHTML = '<div class="sidebar-empty">Start typing to search movies...</div>';
    }

    function openSearchSidebar() {
      document.getElementById('searchSidebar').classList.add('open');
      document.getElementById('searchOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
      
      // Focus search input
      setTimeout(() => {
        document.getElementById('sidebarSearchInput').focus();
      }, 100);
    }

    function closeSearchSidebar() {
      document.getElementById('searchSidebar').classList.remove('open');
      document.getElementById('searchOverlay').classList.remove('show');
      document.body.style.overflow = 'auto';
    }

    function openMovieModalFromSidebar(movieId) {
      // This function should trigger the modal from homepage
      // If on homepage, call the existing openModal function
      if (typeof openModal === 'function') {
        const index = sidebarFilteredMovies.findIndex(m => m.id === movieId);
        if (index !== -1) {
          // Update the global movies array reference for the modal
          if (typeof movies !== 'undefined') {
            movies.length = 0;
            movies.push(...sidebarFilteredMovies);
          }
          openModal(index);
          closeSearchSidebar();
        }
      } else {
        // If not on homepage, redirect to movie detail or landing page
        window.location.href = `/movies/${movieId}/`;
      }
    }

    // Close sidebar with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeSearchSidebar();
      }
    });

    window.allMoviesData = [
    {% for movie in all_movies %}
    {
      id: {{ movie.id }},
      title: "{{ movie.title|escapejs }}",
      year: {{ movie.year }},
      description: "{{ movie.description|default:''|escapejs }}",
      thumbnail: "{% if movie.thumbnail %}{{ movie.thumbnail.url }}{% else %}https://via.placeholder.com/200x300?text=No+Image{% endif %}",
      video: "{% if movie.video %}{{ movie.video.url }}{% endif %}",
      genres: "{{ movie.get_genres_display }}",
      language: "{% if movie.language %}{{ movie.language.name }}{% else %}Unknown{% endif %}",
      cast: "{{ movie.cast|default:''|escapejs }}",
      rating: {{ movie.review_stars|default:0 }},
      views: {{ movie.views|default:0 }},
      length: "{{ movie.movie_length|default:'Unknown' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  </script>
  
  {% block extra_js %}{% endblock %}
  
  <!-- Profile dropdown must be initialized after all other scripts -->
  <script>
    // Ensure profile dropdown works on all pages
    document.addEventListener('DOMContentLoaded', function() {
      // Small delay to ensure all other scripts have loaded
      setTimeout(function() {
        const profileBtn = document.querySelector('.profile-btn');
        const dropdownMenu = document.querySelector('.dropdown-menu');
        
        if (profileBtn && dropdownMenu) {
          // Remove any existing listeners
          profileBtn.replaceWith(profileBtn.cloneNode(true));
          const newProfileBtn = document.querySelector('.profile-btn');
          
          newProfileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', function(e) {
            if (!newProfileBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
              dropdownMenu.classList.remove('show');
            }
          });
        }
      }, 100);
    });
  </script>
  
  <!-- Enhanced JetFlix Video Player JavaScript -->
  <script>
    class JetflixPlayer {
      constructor() {
        this.player = document.getElementById('jetflixPlayer');
        this.video = document.getElementById('jetflixVideo');
        this.playerTitle = document.getElementById('playerTitle');
        this.playerHeader = document.getElementById('playerHeader');
        this.customControls = document.getElementById('customControls');
        this.playPauseBtn = document.getElementById('playPauseBtn');
        this.playIcon = document.getElementById('playIcon');
        this.pauseIcon = document.getElementById('pauseIcon');
        this.centerPlayBtn = document.getElementById('centerPlayBtn');
        this.progressBar = document.getElementById('progressBar');
        this.progressFilled = document.getElementById('progressFilled');
        this.progressBuffered = document.getElementById('progressBuffered');
        this.currentTimeEl = document.getElementById('currentTime');
        this.durationEl = document.getElementById('duration');
        this.volumeSlider = document.getElementById('volumeSlider');
        this.muteBtn = document.getElementById('muteBtn');
        this.volumeIcon = document.getElementById('volumeIcon');
        this.muteIcon = document.getElementById('muteIcon');
        this.fullscreenBtn = document.getElementById('fullscreenBtn');
        this.loadingSpinner = document.getElementById('loadingSpinner');
        this.playerOverlay = document.getElementById('playerOverlay');
        this.qualityBtn = document.getElementById('qualityBtn');
        this.qualityMenu = document.getElementById('qualityMenu');
        this.subtitleBtn = document.getElementById('subtitleBtn');
        this.subtitleMenu = document.getElementById('subtitleMenu');
        this.pipBtn = document.getElementById('pipBtn');
        this.speedDisplay = document.getElementById('speedDisplay');
        this.currentQuality = document.getElementById('currentQuality');
        this.currentSubtitle = document.getElementById('currentSubtitle');
        
        this.controlsTimeout = null;
        this.isPlaying = false;
        this.isDragging = false;
        this.currentSpeed = 1;
        this.currentQualityValue = 'auto';
        this.currentSubtitleValue = 'off';
        
        this.initializeEvents();
      }
      
      initializeEvents() {
        // Video events
        this.video.addEventListener('loadstart', () => this.showLoading());
        this.video.addEventListener('canplay', () => this.hideLoading());
        this.video.addEventListener('timeupdate', () => this.updateProgress());
        this.video.addEventListener('loadedmetadata', () => this.updateDuration());
        this.video.addEventListener('progress', () => this.updateBuffered());
        this.video.addEventListener('play', () => this.onPlay());
        this.video.addEventListener('pause', () => this.onPause());
        this.video.addEventListener('ended', () => this.onEnded());
        
        // Control events
        this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
        this.centerPlayBtn.addEventListener('click', () => this.togglePlayPause());
        this.playerOverlay.addEventListener('click', () => this.togglePlayPause());
        
        // Progress bar
        this.progressBar.addEventListener('click', (e) => this.seek(e));
        this.progressBar.addEventListener('mousedown', () => this.isDragging = true);
        document.addEventListener('mouseup', () => this.isDragging = false);
        this.progressBar.addEventListener('mousemove', (e) => {
          if (this.isDragging) this.seek(e);
        });
        
        // Volume controls
        this.volumeSlider.addEventListener('input', () => this.updateVolume());
        this.muteBtn.addEventListener('click', () => this.toggleMute());
        
        // Fullscreen
        this.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        
        // Picture in Picture
        this.pipBtn.addEventListener('click', () => this.togglePiP());
        
        // Quality and Subtitle dropdowns
        this.qualityBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown('quality');
        });
        
        this.subtitleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown('subtitle');
        });
        
        // Dropdown item clicks
        document.querySelectorAll('#qualityMenu .dropdown-item').forEach(item => {
          item.addEventListener('click', (e) => this.selectQuality(e.target.closest('.dropdown-item').dataset.quality));
        });
        
        document.querySelectorAll('#subtitleMenu .dropdown-item').forEach(item => {
          item.addEventListener('click', (e) => this.selectSubtitle(e.target.closest('.dropdown-item').dataset.subtitle));
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', () => this.closeAllDropdowns());
        
        // Mouse movement for controls
        this.player.addEventListener('mousemove', () => this.showControls());
        this.player.addEventListener('mouseleave', () => this.hideControls());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
      }
      
      open(videoSrc, title) {
        this.playerTitle.textContent = title;
        this.video.src = videoSrc;
        this.player.classList.add('active');
        document.body.style.overflow = 'hidden';
        this.showControls();
        this.centerPlayBtn.classList.add('show');
      }
      
      close() {
        this.video.pause();
        this.video.src = '';
        this.player.classList.remove('active');
        document.body.style.overflow = 'auto';
        this.centerPlayBtn.classList.remove('show');
        this.hideLoading();
      }
      
      togglePlayPause() {
        if (this.video.paused) {
          this.video.play();
        } else {
          this.video.pause();
        }
      }
      
      onPlay() {
        this.isPlaying = true;
        this.playIcon.style.display = 'none';
        this.pauseIcon.style.display = 'block';
        this.centerPlayBtn.classList.remove('show');
      }
      
      onPause() {
        this.isPlaying = false;
        this.playIcon.style.display = 'block';
        this.pauseIcon.style.display = 'none';
        this.centerPlayBtn.classList.add('show');
      }
      
      onEnded() {
        this.isPlaying = false;
        this.playIcon.style.display = 'block';
        this.pauseIcon.style.display = 'none';
        this.centerPlayBtn.classList.add('show');
      }
      
      updateProgress() {
        if (!this.isDragging) {
          const progress = (this.video.currentTime / this.video.duration) * 100;
          this.progressFilled.style.width = progress + '%';
        }
        this.updateTime();
      }
      
      updateBuffered() {
        if (this.video.buffered.length > 0) {
          const buffered = (this.video.buffered.end(0) / this.video.duration) * 100;
          this.progressBuffered.style.width = buffered + '%';
        }
      }
      
      updateDuration() {
        this.durationEl.textContent = this.formatTime(this.video.duration);
      }
      
      updateTime() {
        this.currentTimeEl.textContent = this.formatTime(this.video.currentTime);
      }
      
      formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      
      seek(e) {
        const rect = this.progressBar.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        this.video.currentTime = pos * this.video.duration;
      }
      
      updateVolume() {
        this.video.volume = this.volumeSlider.value / 100;
        if (this.video.volume === 0) {
          this.showMuteIcon();
        } else {
          this.showVolumeIcon();
        }
      }
      
      toggleMute() {
        if (this.video.muted) {
          this.video.muted = false;
          this.showVolumeIcon();
          this.volumeSlider.value = this.video.volume * 100;
        } else {
          this.video.muted = true;
          this.showMuteIcon();
          this.volumeSlider.value = 0;
        }
      }
      
      showVolumeIcon() {
        this.volumeIcon.style.display = 'block';
        this.muteIcon.style.display = 'none';
      }
      
      showMuteIcon() {
        this.volumeIcon.style.display = 'none';
        this.muteIcon.style.display = 'block';
      }
      
      toggleFullscreen() {
        if (!document.fullscreenElement) {
          this.player.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }
      
      showControls() {
        this.playerHeader.classList.remove('hidden');
        this.customControls.classList.remove('hidden');
        clearTimeout(this.controlsTimeout);
        this.controlsTimeout = setTimeout(() => {
          if (this.isPlaying) {
            this.hideControls();
          }
        }, 3000);
      }
      
      hideControls() {
        if (this.isPlaying) {
          this.playerHeader.classList.add('hidden');
          this.customControls.classList.add('hidden');
        }
      }
      
      showLoading() {
        this.loadingSpinner.style.display = 'block';
      }
      
      hideLoading() {
        this.loadingSpinner.style.display = 'none';
      }
      
      handleKeyboard(e) {
        if (!this.player.classList.contains('active')) return;
        
        switch(e.code) {
          case 'Space':
            e.preventDefault();
            this.togglePlayPause();
            break;
          case 'Escape':
            this.close();
            break;
          case 'ArrowLeft':
            this.video.currentTime -= 10;
            break;
          case 'ArrowRight':
            this.video.currentTime += 10;
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.video.volume = Math.min(1, this.video.volume + 0.1);
            this.volumeSlider.value = this.video.volume * 100;
            break;
          case 'ArrowDown':
            e.preventDefault();
            this.video.volume = Math.max(0, this.video.volume - 0.1);
            this.volumeSlider.value = this.video.volume * 100;
            break;
          case 'KeyF':
            this.toggleFullscreen();
            break;
          case 'KeyM':
            this.toggleMute();
            break;
          case 'KeyP':
            this.togglePiP();
            break;
          case 'Comma':
            this.changeSpeed(-0.25);
            break;
          case 'Period':
            this.changeSpeed(0.25);
            break;
          case 'KeyC':
            this.toggleDropdown('subtitle');
            break;
        }
      }
      
      toggleDropdown(type) {
        const menu = type === 'quality' ? this.qualityMenu : this.subtitleMenu;
        const otherMenu = type === 'quality' ? this.subtitleMenu : this.qualityMenu;
        
        otherMenu.classList.remove('show');
        menu.classList.toggle('show');
      }
      
      closeAllDropdowns() {
        this.qualityMenu.classList.remove('show');
        this.subtitleMenu.classList.remove('show');
      }
      
      selectQuality(quality) {
        this.currentQualityValue = quality;
        this.currentQuality.textContent = quality === 'auto' ? 'Auto' : quality + 'p';
        
        document.querySelectorAll('#qualityMenu .dropdown-item').forEach(item => {
          item.classList.toggle('active', item.dataset.quality === quality);
        });
        
        this.closeAllDropdowns();
      }
      
      selectSubtitle(subtitle) {
        this.currentSubtitleValue = subtitle;
        const subtitleNames = {
          'off': 'Off',
          'en': 'English',
          'es': 'Spanish',
          'fr': 'French'
        };
        this.currentSubtitle.textContent = subtitleNames[subtitle];
        
        document.querySelectorAll('#subtitleMenu .dropdown-item').forEach(item => {
          item.classList.toggle('active', item.dataset.subtitle === subtitle);
        });
        
        this.closeAllDropdowns();
      }
      
      togglePiP() {
        if (document.pictureInPictureElement) {
          document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled) {
          this.video.requestPictureInPicture().catch(error => {
            console.error('Error entering PiP mode:', error);
          });
        }
      }
      
      changeSpeed(delta) {
        this.currentSpeed = Math.max(0.25, Math.min(2, this.currentSpeed + delta));
        this.video.playbackRate = this.currentSpeed;
        
        this.speedDisplay.textContent = this.currentSpeed + 'x';
        this.speedDisplay.classList.add('show');
        
        setTimeout(() => {
          this.speedDisplay.classList.remove('show');
        }, 1000);
      }
      }
    }
    
    // Initialize player
    const jetflixPlayer = new JetflixPlayer();
    
    // Global functions for compatibility
    function openJetflixPlayer(videoSrc, title) {
      jetflixPlayer.open(videoSrc, title);
    }
    
    function closeJetflixPlayer() {
      jetflixPlayer.close();
    }
    
    // Make functions available globally
    window.openJetflixPlayer = openJetflixPlayer;
    window.closeJetflixPlayer = closeJetflixPlayer;
  </script>
</body>
</html>