{% extends 'home/base.html' %}
{% load static %}

{% block title %}My Watchlist - JetFlix{% endblock %}

{% block content %}
<style>
  .watchlist-page {
    padding: 2rem 3rem;
    min-height: calc(100vh - 140px);
  }

  .watchlist-header {
    margin-bottom: 2rem;
  }

  .watchlist-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: #fff;
  }

  .watchlist-header p {
    color: #b3b3b3;
    font-size: 1.1rem;
  }

  .watchlist-stats {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #e50914;
    display: block;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #b3b3b3;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .watchlist-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .watchlist-item {
    position: relative;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s;
    cursor: pointer;
  }

  .watchlist-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(229, 9, 20, 0.3);
    transform: translateY(-2px);
  }

  .watchlist-thumbnail {
    width: 100%;
    height: 280px;
    object-fit: cover;
    background: #333;
  }

  .watchlist-info {
    padding: 1rem;
  }

  .watchlist-title {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.5rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .watchlist-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .watchlist-year {
    color: #b3b3b3;
    font-size: 0.9rem;
  }

  .watchlist-rating {
    color: #46d369;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .watchlist-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .btn-play, .btn-remove {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-play {
    background: #e50914;
    color: white;
  }

  .btn-play:hover {
    background: #f40612;
  }

  .btn-remove {
    background: transparent;
    color: #b3b3b3;
    border: 1px solid #444;
  }

  .btn-remove:hover {
    background: #333;
    color: #fff;
  }

  .empty-watchlist {
    text-align: center;
    padding: 4rem 2rem;
    color: #666;
  }

  .empty-watchlist svg {
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-watchlist h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #888;
  }

  .empty-watchlist p {
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }

  .btn-browse {
    background: #e50914;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-browse:hover {
    background: #f40612;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
  }

  @media (max-width: 768px) {
    .watchlist-page {
      padding: 1rem;
    }

    .watchlist-stats {
      flex-direction: column;
      gap: 1rem;
    }

    .watchlist-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .watchlist-header h1 {
      font-size: 2rem;
    }
  }
</style>

<div class="watchlist-page">
  <div class="watchlist-header">
    <h1>My Watchlist</h1>
    <p>Movies you've saved to watch later</p>
  </div>

  <div id="watchlistContent">
    <div class="watchlist-stats">
      <div class="stat-item">
        <span class="stat-value" id="watchlistCount">0</span>
        <span class="stat-label">Movies Saved</span>
      </div>
    </div>

    <div class="watchlist-grid" id="watchlistGrid">
      <!-- Watchlist items will be loaded here -->
    </div>
  </div>

  <div class="empty-watchlist" id="emptyWatchlist" style="display: none;">
    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
    </svg>
    <h3>Your watchlist is empty</h3>
    <p>Start adding movies you want to watch later!</p>
    <a href="{% url 'movies:landing' %}" class="btn-browse">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
      Browse Movies
    </a>
  </div>
</div>

<script>
  let watchlistMovies = [];

  document.addEventListener('DOMContentLoaded', function() {
    loadWatchlist();
  });

  function loadWatchlist() {
    fetch('/movies/api/watchlist/')
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          watchlistMovies = data.movies;
          displayWatchlist(data.movies);
        } else {
          showEmptyWatchlist();
        }
      })
      .catch(error => {
        console.error('Error loading watchlist:', error);
        showEmptyWatchlist();
      });
  }

  function displayWatchlist(movies) {
    const watchlistGrid = document.getElementById('watchlistGrid');
    const watchlistCount = document.getElementById('watchlistCount');
    const emptyWatchlist = document.getElementById('emptyWatchlist');
    const watchlistContent = document.getElementById('watchlistContent');

    watchlistCount.textContent = movies.length;

    if (movies.length === 0) {
      watchlistContent.style.display = 'none';
      emptyWatchlist.style.display = 'block';
      return;
    }

    watchlistContent.style.display = 'block';
    emptyWatchlist.style.display = 'none';

    watchlistGrid.innerHTML = movies.map((movie, index) => `
      <div class="watchlist-item">
        <img src="${movie.thumbnail}" alt="${movie.title}" class="watchlist-thumbnail" onerror="this.src='https://via.placeholder.com/200x280?text=No+Image'">
        
        <div class="watchlist-info">
          <div class="watchlist-title">${movie.title}</div>
          <div class="watchlist-meta">
            <span class="watchlist-year">${movie.year}</span>
            <span class="watchlist-rating">â˜… ${movie.rating.toFixed(1)}</span>
          </div>
          <div class="watchlist-actions">
            <button class="btn-play" onclick="playWatchlistMovie(${index})">Play</button>
            <button class="btn-remove" onclick="removeFromWatchlist(${movie.id}, ${index})">Remove</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function showEmptyWatchlist() {
    document.getElementById('watchlistContent').style.display = 'none';
    document.getElementById('emptyWatchlist').style.display = 'block';
  }

  function playWatchlistMovie(index) {
    const movie = watchlistMovies[index];
    if (movie && movie.video) {
      if (typeof openJetflixPlayer === 'function') {
        openJetflixPlayer(movie.video, movie.title);
      } else {
        // Fallback - open in new tab
        window.open(movie.video, '_blank');
      }
    } else {
      alert('Video not available');
    }
  }

  function removeFromWatchlist(movieId, index) {
    if (!confirm('Remove this movie from your watchlist?')) {
      return;
    }

    fetch('/movies/remove_from_watchlist/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ movie_id: movieId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Remove from local array
        watchlistMovies.splice(index, 1);
        // Refresh display
        displayWatchlist(watchlistMovies);
        showNotification('Removed from watchlist', 'success');
      } else {
        showNotification('Error removing movie', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error removing movie', 'error');
    });
  }

  function showNotification(message, type) {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') notification.style.background = '#4CAF50';
    if (type === 'error') notification.style.background = '#e50914';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}